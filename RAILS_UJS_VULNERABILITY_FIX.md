# Rails UJS Vulnerability Fix
Recently Homakov uncovered a security vulnerbility regarding having javascript code in .js.erb so I discussed this with him and managed to come up with a solution. 

**NOTE This library was designed long before this vulnerability was unconvered, i will write a blog post about why and how it came to be on another day.** 

I just found it interesting because transponder.js actually can solve this problem. IMO pretty nicely too. But i'll let you be the judge of that.

Here is how it works

Normally you would just have a index.js.erb with something like this
```
$('#something').replaceWith("<%= j render 'whatever' %>");
```

What if instead we had some code on the client side that was smart enough to rebuild the above response from a more simplified response from the server.

```
["#something", "<%= xms_event %>", "<%= j render 'whatever' %>"]
```
Basically we're just getting an array as a string, so there is no code execution which means no leakage (I asked homakov and he said that this is safe) I wouldn't say that I am on the same level as him when it comes to security, so I confirmed it with him before writing this.

So how does this work you may ask, you can read the source for handling this response [response.coffee](https://github.com/artellectual/transponder/blob/develop/lib/assets/javascripts/transponder/response.coffee)

```<%= xms_event %>``` came from [xms_event view helper](https://github.com/artellectual/transponder/blob/develop/lib/transponder.rb)

It is designed to only intercept 'application/transmission' Content-Type so there is an after_filter to set this content type. Although it is not a necessity. I am still debating whether we need this or not.

On the client side we have something like this. 

```coffee
class Application.Presenters.ContactsPresenter extends Transponder.Presenter
  presenterName: 'contacts' # so we survive minifiers
  module: 'application' # again so we survive minifiers

  index: ->
    $(@element).replaceWith(@response)
```
So basically code execution happens on the client side you just type in anything you want in the presenter that you would normally do in index.js.erb 

How does this happen? Well basically the ContactsPresenter is listening for an event on 'ujs:application:contacts:index' how does this happen? Read through the source code [presenter.coffee](https://github.com/artellectual/transponder/blob/develop/lib/assets/javascripts/transponder/presenter.coffee)

But this is hard you say? Well not really since we're building a bunch of generators that will allow you to do all this stuff in a matter of a few seconds
```
rails g transponder:presenter contacts 
```
Will generate and setup your presenter for you without you having to lift a finger, well technically you lifted fingers but i mean its pretty quick and painless.

Transponder has a lot more features than this, it was designed exactly to allow better management and control over rails app that have a lot of client side code while still being able to utilize server side templates. Its been used to build a few sites. It was actually extracted from a project we have at our agency.

+ [Codemy](http://www.codemy.net) (there is a whole learning management system behind the landing page)
+ [Yoobook.it](http://www.yoobook.it) (coming soon)
+ [Fitme.mobi](http://www.fitme.mobi)
+ ... And another project I can't disclose due to client NDA ...
